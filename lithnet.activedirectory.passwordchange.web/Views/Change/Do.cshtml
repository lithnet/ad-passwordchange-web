@{
    ViewBag.Title = PasswordChangeConfigSection.Configuration.Branding.Header;
}

@model Lithnet.ActiveDirectory.PasswordChange.Web.Models.PasswordChangeRequestModel

@section Instructions {
    @if (File.Exists(Server.MapPath("~/App_Data/Templates/instructions.html")))
    {
        <section class="instructions" aria-label="password instructions">
            <h5 class="instructions-header">@Resources.Do.HeadingInstructions</h5>
            <div class="instructions-content">

                @Html.Raw(File.ReadAllText(Server.MapPath("~/App_Data/Templates/instructions.html")))

            </div>
        </section>
    }
}

@section FurtherNotes {
    @if (File.Exists(Server.MapPath("~/App_Data/Templates/notes.html")))
    {
        <section class="notes" aria-label="further notes">
            <h5 class="notes-header">@Resources.Do.HeadingNotes</h5>
            <div class="notes-content">
                @Html.Raw(File.ReadAllText(Server.MapPath("~/App_Data/Templates/notes.html")))
            </div>
        </section>
    }
}

@using (Html.BeginForm("Do", "Change", FormMethod.Post))
{
    <h5>@Resources.Do.CurrentDetails</h5>
    <div class="form-section" area-label="password change form">
        <div class="form-row">
            <div class="form-group col-md-6 mr-auto ml-auto">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fa fa-user"></i></span>
                    </div>
                    @{
                        bool usernameError = false;
                        Dictionary<string, object> usernameProps = new Dictionary<string, object>
                                                                {
                                                                    { "class", "form-control" },
                                                                    { "placeholder", ConfigurationManager.AppSettings["username-only"] == "true" ? Resources.Do.UserName : Resources.Do.UserNameOrEmail },
                                                                    { "id", "user-name" },
                                                                    { "aria_label", ConfigurationManager.AppSettings["username-only"] == "true" ? Resources.Do.UserName : Resources.Do.UserNameOrEmail},
                                                                    { "required", true }
                                                                };

                        if (ViewData.ModelState[nameof(Model.UserName)] != null && ViewData.ModelState[nameof(Model.UserName)].Errors.Any())
                        {
                            usernameError = true;
                            usernameProps.Add("aria_invalid", true);
                            usernameProps.Add("aria_describedBy", "usernameValidationText");
                        }

                        if (string.IsNullOrEmpty(Model?.UserName))
                        {
                            usernameProps.Add("autofocus", true);
                        }
                    }
                    @Html.TextBoxFor(model => model.UserName, usernameProps)
                </div>
                @if (usernameError)
                {
                    <div class="alert alert-danger field-alert" role="alert">
                        <i class="fa fa-exclamation-circle"></i> @Html.ValidationMessageFor(model => model.UserName, null, new { @id = "usernameValidationText" })
                    </div>
                }
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6 mr-auto ml-auto">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fa fa-lock"></i></span>
                    </div>
                    @{
                        bool currPasswordError = false;
                        Dictionary<string, object> currPasswordProps = new Dictionary<string, object>
                                                                        {
                                                                            { "class", "form-control" },
                                                                            { "placeholder", Resources.Do.CurrentPassword },
                                                                            { "id", "current-password" },
                                                                            { "aria_label", Resources.Do.CurrentPassword },
                                                                            { "required", true }
                                                                        };

                        if (ViewData.ModelState[nameof(Model.CurrentPassword)] != null && ViewData.ModelState[nameof(Model.CurrentPassword)].Errors.Any())
                        {
                            currPasswordError = true;
                            currPasswordProps.Add("aria_invalid", true);
                            currPasswordProps.Add("aria_describedBy", "currPasswordValidationText");
                        }

                        if (!string.IsNullOrEmpty(Model?.UserName) && !string.IsNullOrEmpty(Model?.CurrentPassword))
                        {
                            currPasswordProps.Add("value", Model.CurrentPassword);
                        }
                        else if (string.IsNullOrEmpty(Model?.CurrentPassword))
                        {
                            currPasswordProps.Add("autofocus", true);
                        }

                    }
                    @Html.PasswordFor(model => model.CurrentPassword, currPasswordProps)
                </div>
                @if (currPasswordError)
                {
                    <div class="alert alert-danger field-alert" role="alert">
                        <i class="fa fa-exclamation-circle"></i> @Html.ValidationMessageFor(model => model.CurrentPassword, null, new { @id = "currPasswordValidationText" })
                    </div>
                }
            </div>
        </div>
    </div>
    <h5>@Resources.Do.NewDetails</h5>
    <div class="form-section">
        <div class="form-row">
            <div class="form-group col-md-6 mr-auto ml-auto">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fa fa-chevron-right"></i></span>
                    </div>

                    @{
                        Dictionary<string, object> newPasswordProps = new Dictionary<string, object>
                                    {
                                        {"class", "form-control"},
                                        {"placeholder", Resources.Do.NewPassword},
                                        {"id", "new-password-input"},
                                        {"aria_label", Resources.Do.NewPassword},
                                        {"required", true}
                                    };
                    }

                    @if (!string.IsNullOrEmpty(Model?.UserName) && !string.IsNullOrEmpty(Model?.CurrentPassword))
                    {
                        newPasswordProps.Add("autofocus", true);
                    }

                    @if (ViewData.ModelState[nameof(Model.NewPassword)] != null && ViewData.ModelState[nameof(Model.NewPassword)].Errors.Any())
                    {
                        newPasswordProps.Add("aria_invalid", true);
                        newPasswordProps.Add("aria_describedBy", "newPasswordValidationText");
                    }

                    @Html.PasswordFor(model => model.NewPassword, newPasswordProps)

                </div>
                @if (ViewData.ModelState[nameof(Model.NewPassword)] != null && ViewData.ModelState[nameof(Model.NewPassword)].Errors.Any())
                {
                    <div class="alert alert-danger field-alert" role="alert">
                        <i class="fa fa-exclamation-circle"></i> @Html.ValidationMessageFor(model => model.NewPassword, null, new { @id = "newPasswordValidationText" })
                    </div>
                }
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-6 mr-auto ml-auto">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="fa fa-chevron-right"></i></span>
                    </div>
                    @if (ViewData.ModelState[nameof(Model.ConfirmNewPassword)] != null && ViewData.ModelState[nameof(Model.ConfirmNewPassword)].Errors.Any())
                    {
                        @Html.PasswordFor(model => model.ConfirmNewPassword, new { @class = "form-control", @placeholder = Resources.Do.ConfirmNewPassword, @aria_label = Resources.Do.ConfirmNewPassword, @aria_invalid = true, @aria_describedBy = "confirmPasswordValidationText" })
                    }
                    else
                    {
                        @Html.PasswordFor(model => model.ConfirmNewPassword, new { @class = "form-control", @placeholder = Resources.Do.ConfirmNewPassword, @aria_label = Resources.Do.ConfirmNewPassword })
                    }

                </div>
                @if (ViewData.ModelState[nameof(Model.ConfirmNewPassword)] != null && ViewData.ModelState[nameof(Model.ConfirmNewPassword)].Errors.Any())
                {
                    <div class="alert alert-danger field-alert" role="alert">
                        <i class="fa fa-exclamation-circle"></i> @Html.ValidationMessageFor(model => model.ConfirmNewPassword, null, new { @id = "confirmPasswordValidationText" })
                    </div>
                }
            </div>
        </div>
        @if (Model?.FailureReason != null)
        {
            <div class="alert alert-danger" role="alert">
                <i class="fa fa-exclamation-circle"></i> @Html.DisplayTextFor(model => model.FailureReason)
            </div>
        }
        @if (Model?.Redirect != null)
        {
            @Html.HiddenFor(model => model.Redirect)
        }
    </div>

    <footer>
        <div id="action-buttons">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-primary">@Resources.Do.ButtonRequestChange</button>

            @{
                CustomLinkElement helpLink = PasswordChangeConfigSection.Configuration.CustomLinks.GetHelpLink;
            }

            @if (helpLink != null)
            {
                <a href="@helpLink.LinkUrl" class="btn btn-outline-primary">@helpLink.LinkText</a>
            }
        </div>
    </footer>
}

